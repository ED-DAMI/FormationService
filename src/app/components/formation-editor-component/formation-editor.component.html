<!-- Fichier: src/app/formation-editor/formation-editor.component.html -->

<header class="sticky-top p-3 bg-white border-bottom shadow-sm d-flex justify-content-between align-items-center">
  <h5 class="text-secondary fw-light mb-0">
    <i class="bi bi-mortarboard-fill me-2 text-primary"></i>
    Édition : <span class="fw-bold text-dark">{{ formation().titre }}</span>
  </h5>

  <div class="d-flex align-items-center gap-3">
    @if (lastSaved()) {
      <small class="text-muted">
        <i class="bi bi-check-circle-fill text-success me-1"></i>
        Sauvegardé à {{ lastSaved() | date:'shortTime' }}
      </small>
    }
    <button class="btn btn-outline-secondary" disabled>
      <i class="bi bi-eye-fill me-2"></i> Prévisualiser
    </button>
    <button class="btn btn-primary fw-bold" (click)="saveFormation()" [disabled]="isSaving()">
      @if (isSaving()) {
        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
        Sauvegarde en cours...
      } @else {
        <i class="bi bi-cloud-arrow-up-fill me-2"></i> Enregistrer
      }
    </button>
  </div>
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="fw-bold mb-0 text-dark">Plan de la Formation</h4>
    <!-- RETIREZ 'disabled' pour activer le bouton d'ajout de cours principal -->
    <button class="btn btn-sm btn-outline-primary" (click)="onAddCours()" title="Ajouter un nouveau cours">
      <i class="bi bi-journal-plus"></i>
    </button>
  </div>
</header>

<!-- 2. CONTENEUR PRINCIPAL (SPLIT VIEW) -->
<div class="d-flex editor-main-container">

  <!-- B. PANNEAU DE STRUCTURE (L'EXPLORER) - Colonne Gauche -->
  <div class="structure-panel p-4 border-end overflow-y-auto">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h4 class="fw-bold mb-0 text-dark">Plan de la Formation</h4>
      <!-- CORRECTION : Activation du bouton d'ajout de cours principal -->
      <button class="btn btn-sm btn-outline-primary" (click)="onAddCours()" title="Ajouter un nouveau cours">
        <i class="bi bi-journal-plus"></i>
      </button>
    </div>

    <!-- Le composant d'exploration de l'arbre avec tous les événements liés -->
    <app-structure-explorer
      [formation]="formation()"

      [currentSelectedItem]="selectedItem()"
      (itemSelected)="onSelectItem($event)"

      (addCours)="onAddCours()"
      (addChapitre)="onAddChapitre($event)"
      (addSection)="onAddSection($event)"

      (removeCours)="onRemoveCours($event)"
      (removeChapitre)="onRemoveChapitre($event)"
      (removeSection)="onRemoveSection($event)">
    </app-structure-explorer>
  </div>

  <!-- C. PANNEAU D'ÉDITION DYNAMIQUE - Colonne Droite (Inchangé) -->
  <!-- ... -->
  <div class="editor-panel flex-grow-1 p-5 overflow-y-auto bg-white">

    @if (selectedItem(); as item) {
      <div class="card shadow-lg border-0 rounded-4">

        <div class="card-body p-4 p-md-5">

          <!-- CORRECTION ICI : Ajout de (formationChange) sur app-formation-form -->
          @if (isFormation(item)) {
            <app-formation-form [formation]="item" (formationChange)="onUpdateSelectedItem($event)"></app-formation-form>

          } @else if (isCours(item)) {
            <app-course-form [cours]="item" (coursChange)="onUpdateSelectedItem($event)"></app-course-form>
          } @else if (isChapitre(item)) {
            <app-chapitre-form [chapitre]="item" (chapitreChange)="onUpdateSelectedItem($event)"></app-chapitre-form>
          } @else if (isSection(item)) {
            <app-section-form [section]="item" (sectionChange)="onUpdateSelectedItem($event)"></app-section-form>
          }

        </div>
      </div>
    } @else {
      <div class="placeholder-editor">
        <i class="bi bi-cursor-fill"></i>
        <h4 class="mt-3 text-dark fw-bold">Aucun élément sélectionné</h4>
        <p class="text-muted">Cliquez sur un élément dans la structure à gauche pour l'éditer.</p>
      </div>
    }
  </div>
</div>
